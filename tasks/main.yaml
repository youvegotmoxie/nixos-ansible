- name: "Create NixOS config dirs"
  ansible.builtin.file:
    path: "/etc/nixos/{{ item }}"
    state: directory
    mode: '0755'
    owner: "{{ username }}"
    group: "{{ username }}"
  loop:
    - system
    - users
    - desktop
    - "users/{{ username }}/secrets"
    - "users/{{ username }}/software"

- name: "Copy main NixOS configuration"
  ansible.builtin.template:
    src: templates/system/{{ item.src }}.nix.j2
    dest: "{{ item.dest }}"
    mode: '0644'
    owner: "{{ username }}"
    group: "{{ username }}"
  loop:
    - { src: 'configuration', dest: '/etc/nixos/configuration.nix' }
    - { src: 'filesystems', dest: '/etc/nixos/system/filesystems.nix' }
    - { src: 'flake', dest: '/etc/nixos/flake.nix' }

- name: "Copy user NixOS configuration"
  ansible.builtin.template:
    src: templates/users/{{ item.src }}.nix.j2
    dest: "{{ item.dest }}"
    mode: '0644'
    owner: "{{ username }}"
    group: "{{ username }}"
  loop:
    - { src: "{{ username }}", dest: "/etc/nixos/users/{{ username }}.nix" }
    - { src: 'flatpak', dest: "/etc/nixos/users/{{ username }}/software/flatpak.nix" }
    - { src: 'home', dest: "/etc/nixos/users/{{ username }}/home.nix" }

- name: "Copy user NixOS home-manager software configuration(s)"
  ansible.builtin.template:
    src: templates/users/software/{{ item }}.nix.j2
    dest: /etc/nixos/users/{{ username }}/software/{{ item }}.nix
    mode: '0644'
    owner: "{{ username }}"
    group: "{{ username }}"
  loop:
    - atuin
    - bash
    - btop
    - ghostty
    - git
    - starship
    - zoxide

- name: "Copy Gnome environment NixOS configuration"
  ansible.builtin.template:
    src: templates/desktop/gnome/{{ item }}.nix.j2
    dest: /etc/nixos/desktop/{{ item }}.nix
    mode: '0644'
    owner: "{{ username }}"
    group: "{{ username }}"
  loop:
    - gnome
  when:
    - gnome_enabled is defined
    - gnome_enabled

- name: "Copy Hyprland NixOS configuration"
  ansible.builtin.template:
    src: templates/desktop/hypr/{{ item }}.nix.j2
    dest: /etc/nixos/desktop/{{ item }}.nix
    mode: '0644'
    owner: "{{ username }}"
    group: "{{ username }}"
  loop:
    - hyprland
  when:
    - hyprland_enabled is defined
    - hyprland_enabled

- name: "Copy Hyprland user configuration for {{ username }}"
  ansible.builtin.copy:
    src: "files/hypr/{{ item }}.conf"
    dest: "/home/{{ username }}/.config/hypr/{{ item }}.conf"
    mode: '0644'
    owner: "{{ username }}"
    group: "{{ username }}"
  loop:
    - hyprland
    - hypridle
    - hyprlock
  when:
    - hyprland_enabled is defined
    - hyprland_enabled

- name: "Copy SOPS encrypted secret file"
  ansible.builtin.copy:
    src: "files/secrets/global.yaml"
    dest: "/etc/nixos/users/{{ username }}/secrets/global.yaml"
    mode: '0600'
    owner: "{{ username }}"
    group: "{{ username }}"
